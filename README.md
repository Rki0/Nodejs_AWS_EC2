# 😇 배포 (React + Node.js + express + mongoDB + mongoose)

# 이 배포는 중단했습니다! 무료 기능들이 막혀서 Heroku로 돌아갔습니다

[Heroku, Netlify로 배포하기](https://github.com/Rki0/RootingForYou_Deployed)

# ⬆️ 위 링크를 참고해주세요

배포가 가장 어려울 줄은 상상도 못했다.  
Node.js와 express, mongoDB와 mongoose는 모두 처음 사용해보는 것임에도 불구하고 자료가 많았고, 버전에 따른 차이도 따라잡기 쉬웠는데, 배포는 정말이지...
일주일을 전부 쏟아붓게 될 줄은 ㅠㅠ  
사람마다 잘 돌아가기도 하고, 막히는 사람도 있는 것으로 보인다.

우선, 배포는 프론트와 백을 나눠서 진행했다.  
프론트는 Netlify, 백은 AWS EC2를 사용했다.  
처음에는 Heroku를 통해서 한번에 배포하려고 했지만 3~4일 정도 시도해본 결과, 진행이 불가능할 정도로 git 관련 커맨드가 뒤엉켜버렸고, 심지어 mLab에서 제공해주던 무료 mongoDB 연동이 더 이상 지원을 안하는 것을 확인한 뒤에는 Heroku를 내려놨다. 다른 DB와 연동이 무료라면 그 DB를 써보는 것도 나쁘지않을 것 같다. (사실, 간단함만 따지면 Heroku가 더 좋은 것 같다..)  
각설하고, 일주일 간의 고생을 잊지않기 위해 배포를 어떻게 진행했는지 기록하고자한다.  
참고로 맥북 기준입니다!

## 📂 Backend 파일 구조

<img width="170" alt="스크린샷 2022-07-17 오전 9 53 55" src="https://user-images.githubusercontent.com/86224851/179379528-90d39f46-5e5c-4f7d-b657-acb717d8db05.png">

## 😵 Backend (AWS EC2 사용)

회원가입, 로그인 등은 생략하겠다.

### 1단계 - EC2 서비스 페이지에 접속해서 인스턴스 생성하고 이름 커스텀하기

<img width="793" alt="스크린샷 2022-07-16 오후 2 46 29" src="https://user-images.githubusercontent.com/86224851/179341787-17ae1958-afb2-4153-8ad1-509fe16e527e.png">

인스턴스의 이름을 설정하는 부분이다.  
말그대로 인스턴스의 이름을 정하는 것이므로 본인이 구별 가능하게 생성하자.

### 2단계 - AMI 설정하기

<img width="763" alt="스크린샷 2022-07-16 오후 2 47 59" src="https://user-images.githubusercontent.com/86224851/179341840-08fb66d4-f806-417a-a51a-b230c9ad6aac.png">

AMI를 설정하는 것인데...아무래도 EC2 서비스를 사용하기 위해 어떤 엔진을 사용할 것인지를 고르는 것 같다.  
"프리 티어 사용 가능"이 붙어 있는 것은 무료이므로, 그걸 고르자.  
필자는 Linux로 처음 시도했다가, 터미널에서 커맨드 오류가 너무 많이 발생해서, Ubuntu로 생성했다.(실제로 자료들도 Ubuntu로 작성된게 많았다)

### 3단계 - 인스턴스 유형 설정하기

<img width="790" alt="스크린샷 2022-07-16 오후 2 51 24" src="https://user-images.githubusercontent.com/86224851/179341928-f6665507-eef3-4c4f-ab66-31d655bcba88.png">

이 부분도 "프리 티어 사용 가능"인 것을 선택하자.  
필자는 t2.micro를 선택했다.  
요금이 적혀있는 것을 볼 수 있는데 AWS는 가입 후 1년 동안은 한달 750시간(?) 가동까지는 무료이므로, 일단은 넘어가도록 하자.(한달 내내 서버를 돌려도 750 시간이 안 넘는다고 한다)

### 4단계 - 키 페어 설정하기

<img width="787" alt="스크린샷 2022-07-16 오후 2 53 34" src="https://user-images.githubusercontent.com/86224851/179342001-458a73ca-cdd4-46a4-823f-99e36d7f8b5a.png">

키 페어는 나중에 터미널에서 AWS 서비스에 로그인할 때 필요하므로 잘 기억해놓도록 하자.

### 5단계 - 인스턴스 시작 누르기

여기까지 왔다면, 그 외 것들은 따로 건드릴 필요가 없다.  
특히나, 개인 프로젝트라면 더더욱 커스텀할 일이 없을 것이다.  
그러므로 바로 인스턴스 시작을 누르고 실행하는 것으로 하자.

### 6단계 - 사용할 인스턴스 클릭 후 연결 버튼 누르기

<img width="1440" alt="스크린샷 2022-07-16 오후 2 56 44" src="https://user-images.githubusercontent.com/86224851/179342118-2934ff26-2449-43e6-90dc-7b498759d612.png">

연결 버튼을 누르면 아래와 같은 화면을 볼 수 있을 것이다.

<img width="806" alt="스크린샷 2022-07-16 오후 2 59 39" src="https://user-images.githubusercontent.com/86224851/179342224-a7dd2777-133c-4484-849c-cd2376e6e62f.png">

우리는 가장 아래에 있는 붉은 상자를 사용할 것이다.(ssh -i로 시작하는 부분)  
어디서? 터미널을 켜서!

### 7단계 - 터미널 켜고 코드 복사해서 넣기

바로 위에서 말한 코드를 복사해서 그대로 터미널에 입력하자.
그럼 이런 식으로 진행 될 것이다.

<img width="567" alt="스크린샷 2022-07-16 오후 3 04 24" src="https://user-images.githubusercontent.com/86224851/179342361-0b508659-9ade-4527-a3d3-c07c71d0e103.png">

### 8단계 - mkdir 커맨드로 디렉토리 생성하기

이제 AWS에 접속이 되었다.  
ubuntu@ip-내 ip 주소 <-- 이런 식으로 커맨드 라인이 바뀌었을 것이다.  
mkdir 커맨드로 아무 디렉토리나 생성해주자.  
사실, 지금와서 생각하면 안 만들어도 될 것 같기는한데, 필자는 에러로 고생을 많이해서 그런지, 브랜치를 여러개로 나눠서 시도하는게 정신건강에 이로울 것으로 판단하여 이런 방식으로 진행했다.

```
$ mkdir 디렉토리이름
$ cd 디렉토리이름
```

### 9단계 - 소스 코드 깃허브로부터 클론하기

디렉토리에 접근해서 소스 코드를 넣어주자.  
github에 올려놓고 클론하는 방법이 가장 보편적인 것으로 보인다.

```
$ git clone 소스코드깃허브주소
```

클론이 완료되면 제대로 들어갔는지 확인해보자

```
$ ls
```

ls 커맨드는 하위 디렉토리들을 보여주는 명령어인데,  
깃 클론을 완료했다면, 깃허브에 생성했던 Repository 이름과 동일한 디렉토리가 생성되어 있는 것을 확인할 수 있다.

```
$ cd Repository이름
```

### 10단계 - 서버 활성화해보기

Repository이름과 동일한 디렉토리에 접근하게 된다면, 소스코드에 접근할 수 있게 된 것이다.  
이제 코드를 동작시켜보자.

```
$ npm install
$ npm run start
```

npm install은 다들 아시다시피 package.json에 있는 dependencies를 설치하는 명령어이다.  
npm run start는 사람마다 커맨드 scripts를 다르게 설정해놓을 수도 있기 때문에 정확하게 말하기는 힘들지만, 필자의 경우

```js
"start": "node index.js"
```

로 설정해놨다. 파일 구조는 맨 위에서 보여드렸으므로, 어떤 파일에 동작할지는 설명을 생략하겠다.

<img width="254" alt="스크린샷 2022-07-17 오전 9 55 01" src="https://user-images.githubusercontent.com/86224851/179379563-6691781c-c586-438c-ac80-f4a469ea173b.png">

짜잔~ 정상적으로 코드가 동작하는 것을 확인할 수 있다.  
원래 > 표시가 있는 곳까지만 보이고, 필자는 console.log를 사용해서 추가로 문장이 나온 것이다.

## Frontend (Netlify 사용)

이제 서버를 동작시켜봤으니, 클라이언트 쪽을 배포해보자.  
Netlify를 사용하였는데, 정말 간편했다.  
다만, 간편한 것과 에러는 관련이 없다...  
여기서도 꽤나 헤맸던 부분이 있어서 기록을 남기고자 한다.  
처음부터 끝까지 설명을 작성하고 싶었으나, 깃허브 연동을 전부 마쳐버려서 가장 헤맸던 부분만!!! 설명을 적도록하겠다 ㅠㅠ

### 1단계 - 배포 설정하기

깃허브 계정 연동 후, Repository에 대한 접근 권한을 모두 허가하면, 본인이 지금까지 만들었던 Repository가 전부 보이게 된다.  
그 중에서 배포하고자 하는 Repository를 선택하면 아래와 같은 화면으로 올 수 있을 것이다.

<img width="708" alt="스크린샷 2022-07-17 오전 10 35 37" src="https://user-images.githubusercontent.com/86224851/179380295-3effd770-8938-4e62-9aeb-58045dea7570.png">

Owner는 깃허브 닉네임, Branch to deploy는 배포할 브랜치를 선택하는 곳이다.  
그 아래에 Base directory는 여러 개의 폴더를 올려놨을 때, 어떤 폴더를 배포할 것인지 선택하는 것이다. 보통 client라는 폴더명으로 프론트쪽을 구분하시는 분이 많으시므로, client에 프론트 소스 코드를 전부 넣었다고 가정해보자.  
client와 server 폴더를 둘 다 올려놓은 깃허브 Repository에서 Netlify가 어떤 폴더를 배포할지를 선택해주는 것이다. 이런 상황에서는 client 폴더를 배포해야하므로, client라고 적어놓으면 된다.  
필자는 프론트 소스 코드와, 백 소스 코드를 다른 Repository에 올렸기 때문에 아무것도 적지 않았다.  
다음으로는 Build command이다. 이 것은 scripts에 적어놓은 커맨드를 실행하는데, 어떤 커맨드를 실행할 것인지를 묻는 것이다.  
필자는 React로 프로젝트를 진행했으므로, 코드를 그대로 올리면 웹 페이지가 읽을 수가 없다. 그래서 build 과정을 통해 웹 페이지가 이해할 수 있는 형태로 전환하고, 그 폴더를 깃헙에 올려서 동작시키는 과정을 많이들 경험하셨을 거다.  
여기서도 똑같다. build를 해줘야지 React 코드를 변환해서 배포할 수 있다.

```
CI= npm run build
```

라고 적어주자. 이 부분도 사람마다 build를 동작시킬 scipts 커맨드가 다를 수 있지만, 아무것도 안 건드리셨다면 build 커맨드로 동작할 것이다.  
앞에 CI= 이라는 요상한게 붙어있는데, 이는 Netlify에서 build 커맨드를 동작시킬 때 적어줘야한다.(조금씩 보이는 정보에 의하면 20년인가 21년부터 적어줘야하는 것으로 변경되었다고 한다.)  
만약에 안 적으면 build 오류가 발생하므로 반드시 적어주자.(필자는 이걸 몰라서 고생을 많이..했다..)  
마지막으로 Publish directory가 있다. 이는 어떤 폴더를 배포할지 정하는 것이다...위에 있는 설명이랑 같은데?라고 생각하실 수 있는데, 내 어휘력의 한계같기도 하고...  
Base directory에서는 server, client 등의 최상위 파일들의 경로를 정해주는 것였다면, 여기서는 client 내에서 어떤 파일이 배포되는지를 세부적으로 정하는 단계라고 보시면 될 것 같다.  
보통 React 프로젝트를 CRA로 생성하면 최상위 폴더가 없는 상태에서 시작한다.(예를 들어, client, server 등등..)  
따라서, 그 상태에서 build를 하면 같은 레벨의 폴더에 build 폴더가 생성이 되는데, 만약, 개발자가 임의로 client 폴더를 만들어서 프론트를 구분해주면 그 때부터는 client 안에 build가 생성이 되지않겠는가? 그 때의, build 폴더를 선택해서 배포할 수 있도록 만드는 과정인 것이다!

자, 이제 Deploy site를 클릭하면 배포가 진행될 것이다.  
Deploy 상태를 실시간으로 확인할 수 있다. 보통 아래와 같은 장면이 나오면 성공이다!

<img width="719" alt="스크린샷 2022-07-17 오전 11 01 15" src="https://user-images.githubusercontent.com/86224851/179380845-5e0f0853-2134-4564-aba8-5e2098087ebc.png">

더 쉽게, 성공 여부를 판단하고자 한다면,

<img width="581" alt="스크린샷 2022-07-17 오전 11 22 33" src="https://user-images.githubusercontent.com/86224851/179381264-185fe08d-4b65-455c-af1c-3c18a6fe0e5f.png">

Published가 표시된 것만 봐도 된다.  
필자는 오류가 너무 많이 발생해서, 실시간으로 배포 진행을 살펴보는게 습관이 되버려서..
